<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BRACu Socials</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .action-btn {
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        @media (max-width: 968px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="dashboard.html" class="logo">BRACu Socials</a>
            <nav>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="friends.html">Friends</a></li>
                    <li><a href="groups.html">Groups</a></li>
                    <li><a href="events.html">Events</a></li>
                    <li><a href="schedule.html">Schedule</a></li>
                    <li><a href="location.html">Location</a></li>
                    <li><a href="profile.html">Profile</a></li>
                </ul>
            </nav>
            <div class="user-info"></div>
        </div>
    </header>

    <div class="container">
        <h1>Dashboard</h1>

        <div class="dashboard-grid">
            <div class="main-content">
                <div class="card">
                    <div class="card-header">Friend Suggestions</div>
                    <div id="friendSuggestions" class="grid grid-2"></div>
                </div>

                <div class="card">
                    <div class="card-header">Friends Nearby</div>
                    <div id="nearbyFriends"></div>
                </div>

                <div class="card">
                    <div class="card-header">Upcoming Events</div>
                    <div id="upcomingEvents"></div>
                </div>

                <div class="card">
                    <div class="card-header">Recommended Groups</div>
                    <div id="recommendedGroups" class="grid grid-2"></div>
                </div>
            </div>

            <div class="sidebar">
                <div class="card">
                    <div class="card-header">Quick Actions</div>
                    <div class="quick-actions">
                        <div class="action-btn card" onclick="window.location.href='friends.html'">
                            <div style="font-size: 32px;">üë•</div>
                            <div>Find Friends</div>
                        </div>
                        <div class="action-btn card" onclick="window.location.href='events.html'">
                            <div style="font-size: 32px;">üéâ</div>
                            <div>Create Event</div>
                        </div>
                        <div class="action-btn card" onclick="window.location.href='location.html'">
                            <div style="font-size: 32px;">üìç</div>
                            <div>Check-in</div>
                        </div>
                        <div class="action-btn card" onclick="window.location.href='groups.html'">
                            <div style="font-size: 32px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                            <div>Join Group</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Popular Spots</div>
                    <div id="popularSpots"></div>
                </div>

                <div class="card">
                    <div class="card-header">Recent Notifications</div>
                    <div id="recentNotifications"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script>
        if (!requireAuth()) {
        }

        updateNavbar();

        async function loadDashboard() {
            showLoading('friendSuggestions');
            showLoading('nearbyFriends');
            showLoading('upcomingEvents');
            showLoading('recommendedGroups');
            showLoading('popularSpots');
            showLoading('recentNotifications');
            
            try {
                const [suggestions, nearby, events, groups, spots, notifications] = await Promise.all([
                    apiRequest('/smart-matching/suggest-friends').catch(() => []),
                    apiRequest('/smart-matching/recommend-nearby').catch(() => []),
                    apiRequest('/events/my-events').catch(() => []),
                    apiRequest('/smart-matching/recommend-groups').catch(() => []),
                    apiRequest('/smart-matching/popular-spots').catch(() => []),
                    apiRequest('/notifications').catch(() => [])
                ]);
                
                displayFriendSuggestions(suggestions);
                displayNearbyFriends(nearby);
                displayUpcomingEvents(events.slice(0, 3));
                displayRecommendedGroups(groups);
                displayPopularSpots(spots);
                displayRecentNotifications(notifications.slice(0, 5));
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Failed to load some dashboard data', 'error');
            }
        }

        function displayFriendSuggestions(suggestions) {
            const container = document.getElementById('friendSuggestions');
            if (suggestions.length === 0) {
                showEmptyState('friendSuggestions', 'No suggestions available', 'üë•');
                return;
            }

            container.innerHTML = suggestions.slice(0, 6).map(user => `
                <div class="user-card">
                    <img src="/uploads/${user.Profile_pic}" alt="${sanitizeHTML(user.Full_name)}" onerror="this.src='../assets/images/default-avatar.svg'">
                    <div class="user-info-card">
                        <h3><a href="view-profile.html?id=${user.ID}" style="color: inherit; text-decoration: none;">${sanitizeHTML(user.Full_name)}</a></h3>
                        <p>${sanitizeHTML(user.Department || 'No dept')} ${user.Year ? '- Year ' + user.Year : ''}</p>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="sendFriendRequest(${user.ID})">Add Friend</button>
                            <a href="view-profile.html?id=${user.ID}" class="btn btn-secondary btn-sm">View</a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayNearbyFriends(friends) {
            const container = document.getElementById('nearbyFriends');
            if (friends.length === 0) {
                showEmptyState('nearbyFriends', 'No friends nearby', 'üìç');
                return;
            }

            container.innerHTML = friends.map(friend => `
                <div class="user-card">
                    <img src="/uploads/${friend.Profile_pic}" alt="${sanitizeHTML(friend.Full_name)}" onerror="this.src='../assets/images/default-avatar.svg'">
                    <div class="user-info-card">
                        <h3>${sanitizeHTML(friend.Full_name)}</h3>
                        <p>üìç ${sanitizeHTML(friend.location_name)}</p>
                        <p style="font-size: 12px; color: var(--text-secondary);">${getTimeAgo(friend.Created_at)}</p>
                    </div>
                </div>
            `).join('');
        }

        function displayUpcomingEvents(events) {
            const container = document.getElementById('upcomingEvents');
            if (events.length === 0) {
                showEmptyState('upcomingEvents', 'No upcoming events', 'üéâ');
                return;
            }

            container.innerHTML = events.map(event => `
                <div class="card" style="margin-bottom: 10px;">
                    <h3 style="margin-bottom: 5px;">${sanitizeHTML(event.Name)}</h3>
                    <p><strong>üìç</strong> ${sanitizeHTML(event.location)}</p>
                    <p><strong>üïê</strong> ${formatDate(event.event_time)}</p>
                    <button class="btn btn-outline btn-sm" onclick="window.location.href='events.html'">View Details</button>
                </div>
            `).join('');
        }

        function displayRecommendedGroups(groups) {
            const container = document.getElementById('recommendedGroups');
            if (groups.length === 0) {
                showEmptyState('recommendedGroups', 'No recommendations', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶');
                return;
            }

            container.innerHTML = groups.slice(0, 6).map(group => {
                let actionBtn = '';
                if (group.has_pending_request > 0) {
                    actionBtn = '<span style="color: var(--warning);">‚è≥ Pending</span>';
                } else if (group.Privacy === 'private') {
                    actionBtn = `<button class="btn btn-secondary btn-sm" onclick="requestJoinGroup(${group.ID})">Request to Join</button>`;
                } else {
                    actionBtn = `<button class="btn btn-secondary btn-sm" onclick="joinGroup(${group.ID})">Join Group</button>`;
                }

                return `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <h3 style="margin: 0;"><a href="view-group.html?id=${group.ID}" style="color: inherit;">${sanitizeHTML(group.Name)}</a></h3>
                            <span style="font-size: 11px; padding: 2px 6px; border-radius: 8px; background: ${group.Privacy === 'private' ? 'var(--warning)' : 'var(--success)'}; color: ${group.Privacy === 'private' ? '#000' : '#fff'};">${group.Privacy}</span>
                        </div>
                        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">${group.member_count} members</p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <a href="view-group.html?id=${group.ID}" class="btn btn-primary btn-sm">View</a>
                            ${actionBtn}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayPopularSpots(spots) {
            const container = document.getElementById('popularSpots');
            if (spots.length === 0) {
                showEmptyState('popularSpots', 'No data', 'üìä');
                return;
            }

            container.innerHTML = spots.slice(0, 5).map(spot => `
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                    <span>${sanitizeHTML(spot.Name)}</span>
                    <span class="status-badge status-online">${spot.check_in_count} check-ins</span>
                </div>
            `).join('');
        }

        function displayRecentNotifications(notifications) {
            const container = document.getElementById('recentNotifications');
            if (notifications.length === 0) {
                showEmptyState('recentNotifications', 'No notifications', 'üîî');
                return;
            }

            container.innerHTML = notifications.map(notif => `
                <div style="padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                    <p style="font-size: 14px;">${sanitizeHTML(notif.Message)}</p>
                    <p style="font-size: 12px; color: var(--text-secondary);">${getTimeAgo(notif.Created_at)}</p>
                </div>
            `).join('');
        }

        async function sendFriendRequest(userId) {
            try {
                await apiRequest('/friends/request', {
                    method: 'POST',
                    body: JSON.stringify({ receiver_id: userId })
                });
                showToast('Friend request sent!', 'success');
                loadDashboard();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function joinGroup(groupId) {
            try {
                const result = await apiRequest(`/groups/${groupId}/join`, { method: 'POST' });
                showToast(result.message, 'success');
                loadDashboard();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function requestJoinGroup(groupId) {
            try {
                const result = await apiRequest(`/groups/${groupId}/join`, { method: 'POST' });
                showToast(result.message, 'success');
                loadDashboard();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        loadDashboard();
    </script>
</body>
</html>
